Ext.namespace("paCore");Ext.namespace("ajaxpa");Ext.BLANK_IMAGE_URL="/resources/ajaxhelper/ext2/resources/images/default/s.gif";paCore=function(c,b,a){this.package_id=c;this.xmlhttpurl=b;this.packageurl=a};paCore.prototype={createTreeloader:function(){var a=new Ext.tree.TreeLoader({dataUrl:this.xmlhttpurl+"load-treenodes",baseParams:{package_id:this.package_id}});return a},createPhotoStore:function(b){var a=new Ext.data.JsonStore({url:b.xmlhttpurl+"get-photos",totalProperty:"totalPhotos",root:"photos",id:"photo_id",fields:[{name:"photo_id",type:"int"},{name:"view_image_id",type:"int"},{name:"thumb_photo_id",type:"int"},{name:"caption"},{name:"shortcaption"},{name:"path"},{name:"story"},{name:"fullimage_path"},{name:"shadowbox"}]});return a},formSubmit:function(e,g,b,d,f,h,c,i){switch(e){case"addfolder":var a=this.packageurl+"folder-add";break;case"editfolder":var a=this.packageurl+"folder-edit";break;case"addalbum":var a=this.packageurl+"album-add";break;case"editalbum":var a=this.packageurl+"album-edit";break;case"editphoto":var a=this.packageurl+"photo-edit";break}if(a){g.submit({url:a,waitMsg:b,params:d,scope:i,success:h,failure:c})}},doAction:function(g,a,e,b,h,f){var d=null;switch(g){case"deletefolder":d=this.packageurl+"folder-delete";break;case"deletealbum":d=this.packageurl+"album-delete";break;case"deletephoto":d=this.packageurl+"photo-delete";break;case"getonephoto":d=this.xmlhttpurl+"get-onephoto";break;case"getnextobjid":d=this.xmlhttpurl+"nextobjid";break;case"movephoto":d=this.xmlhttpurl+"move-photos";break;case"movenode":d=this.xmlhttpurl+"move-node";break}if(d){var c={url:d,success:a,failure:e,params:h};if(b){c.callback=b}if(a){c.success=a}if(e){c.failure=e}if(f){c.scope=f}Ext.Ajax.request(c)}}};ImageDragZone=function(a,b){this.view=a;ImageDragZone.superclass.constructor.call(this,a.getEl(),b)};Ext.extend(ImageDragZone,Ext.dd.DragZone,{getDragData:function(h){var j=h.getTarget(".thumb-wrap");if(j){var l=this.view;if(h.ctrlKey==false){if(!l.isSelected(j)){l.onClick(h)}}var b=l.getSelectedNodes();var c={nodes:b};if(b.length==1){c.ddel=j.firstChild;c.single=true}else{var a=document.createElement("div");a.className="multi-proxy";for(var d=0,g=b.length;d<g;d++){var k=b[d].firstChild.cloneNode(true);Ext.get(k).setSize(50,50,false);a.appendChild(k);if((d+1)%3==0){a.appendChild(document.createElement("br"))}}var f=document.createElement("div");f.innerHTML=d+" images selected";Ext.get(f).setStyle("clear","both");a.appendChild(f);c.ddel=a;c.multi=true}return c}return false},getTreeNode:function(){var e=[];var b=this.view.getRecords(this.dragData.nodes);for(var c=0,a=b.length;c<a;c++){var d=b[c].data;e.push(new Ext.tree.TreeNode({text:d.name,icon:"../view/"+d.url,data:d,leaf:true,cls:"image-node"}))}return e},afterRepair:function(){for(var b=0,a=this.dragData.nodes.length;b<a;b++){Ext.fly(this.dragData.nodes[b]).frame("#8db2e3",1)}this.dragging=false},getRepairXY:function(b){if(!this.dragData.multi){var a=Ext.Element.fly(this.dragData.ddel).getXY();a[0]+=3;a[1]+=3;return a}return false}});ajaxpa=function(a){this.config=null;this.layout=null;this.xmlhttpurl="/ajaxpa/xmlhttp/";this.shadowbox_gallery=[];this.genericErrorFn=function(){Ext.Msg.alert("Error","Sorry, an error occurred. Please try again later.")};this.restore_window=function(){window.focus();this.refreshTreenode()};this.initObj=function(){if(!Ext.isIE){window.addEventListener("dragdrop",function(b){b.stopPropagation()},false)}if(Ext.isSafari){window.addEventListener("dragover",function(b){b.returnValue=false},false)}if(a){this.config=a;if(this.config.xmlhttpurl){this.xmlhttpurl=this.config.xmlhttpurl}}if(this.config.user_id!=0){this.thumbTemplate=new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="wrap{photo_id}">','<div class="thumb" id="thumb{photo_id}" style="width:150px;height:110px;background:url({path}) no-repeat center center" ','<tpl if="story">','ext:qtip="{story}"',"</tpl>","></div>",'<div id="caption-{photo_id}" class="img_caption" ext:qtip="{caption}">{shortcaption}</div>','<div id="tools-{photo_id}" class="img_tools" style="visibility:hidden">','<img id="view-{photo_id}" ext:qtip="View Photo" class="img_view" src="/resources/ajaxhelper/icons/magnifier.png" border=0 />&nbsp;','<img id="downoad-{photo_id}" ext:qtip="Download Photo" class="img_download" src="/resources/ajaxhelper/icons/arrow_down.png" border=0 />&nbsp;','<img id="edit-{photo_id}" ext:qtip="Edit Properties" class="img_edit" src="/resources/ajaxhelper/icons/image_edit.png" border=0 />&nbsp;','<img id="delete-{photo_id}" ext:qtip="Delete" class="img_delete"src="/resources/ajaxhelper/icons/cross.png" border=0 />',"</div></div>","</tpl>",'<div class="x-clear"></div>')}else{this.thumbTemplate=new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="wrap{photo_id}">','<div class="thumb" id="thumb{photo_id}" style="width:150px;height:110px;background:url({path}) no-repeat center center" ','<tpl if="story">','ext:qtip="{story}"',"</tpl>","></div>",'<div id="caption-{photo_id}" class="img_caption" ext:qtip="{caption}">{shortcaption}</div>','<div id="tools-{photo_id}" ext:qtip="View Photo" class="img_tools" style="visibility:hidden;text-align:right">','<img id="view-{photo_id}" ext:qtip="Download Photo" class="img_download" src="/resources/ajaxhelper/icons/magnifier.png" border=0 />',"</div></div>","</tpl>",'<div class="x-clear"></div>')}this.paCore=new paCore(this.config.package_id,this.xmlhttpurl,this.config.package_url);this.photoStore=this.paCore.createPhotoStore(this);this.photoStore.on("load",function(d,c){this.shadowbox_gallery=[];for(var b=0;b<c.length;b++){this.shadowbox_gallery.push(c[b].get("shadowbox"))}},this);Ext.QuickTips.init();Shadowbox.init({handleOversize:"drag",skipSetup:true});this.initLayout()};Ext.onReady(this.initObj,this,true)};ajaxpa.prototype={initLayout:function(){var b=[this.createCenter(),this.createNav()];if(this.config!=null&&this.config.layoutdiv){Ext.get(this.config.layoutdiv).setHeight(500,false);Ext.get(this.config.layoutdiv).update("");this.layout=new Ext.Panel({id:"pa-ui",layout:"border",applyTo:this.config.layoutdiv,monitorResize:true,items:b})}else{this.layout=new Ext.Viewport({id:"pa-ui",layout:"border",items:b})}var a=new ImageDragZone(Ext.getCmp("pa-thumbsview-data"),{containerScroll:true,ddGroup:"photosDD"})},checkPerms:function(a){var b=Ext.getCmp("pa-nav").getSelectionModel().getSelectedNode();if(a=="read"){return b.attributes.attributes.read_p}else{return b.attributes.attributes.write_p}},createNav:function(){var c=new Ext.tree.AsyncTreeNode({text:this.config.rootfolder_name,expanded:true,id:this.config.rootfolder_id,attributes:{type:"folder",read_p:this.config.root_read_p,write_p:this.config.root_write_p}});var a=this.paCore.createTreeloader();var d=new Ext.menu.Menu({id:"newmenu",items:[{id:"menu_newfolder",text:acs_lang_text.folder||"Folder",icon:"/resources/ajaxhelper/icons/folder.png",cls:"x-btn-text-icon",handler:this.addTreenode.createDelegate(this,["folder"])},{id:"menu_newalbum",text:acs_lang_text.album||"Album",icon:"/resources/ajaxhelper/icons/folder_picture.png",cls:"x-btn-text-icon",handler:this.addTreenode.createDelegate(this,["album"])},{id:"menu_newphoto",text:acs_lang_text.photo||"Photo",icon:"/resources/ajaxhelper/icons/picture.png",cls:"x-btn-text-icon",handler:this.newPhoto,scope:this}]});var b=new Ext.tree.TreePanel({id:"pa-nav",region:"east",title:acs_lang_text.foldersandalbums||"Folders & Albums",split:true,width:250,monitorResize:true,minSize:175,maxSize:400,autoScroll:true,ddAppendOnly:true,animate:true,enableDD:true,ddGroup:"photosDD",collapsible:true,collapseMode:"mini",hideCollapseTool:true,containerScroll:true,tbar:[{text:acs_lang_text.newitem||"New",icon:"/resources/ajaxhelper/icons/add.png",cls:"x-btn-text-icon",menu:d},{text:acs_lang_text.edititem||"Edit",icon:"/resources/ajaxhelper/icons/page_white_edit.png",cls:"x-btn-text-icon",handler:this.editTreenode,scope:this},{text:acs_lang_text.deleteitem||"Delete",icon:"/resources/ajaxhelper/icons/delete.png",cls:"x-btn-text-icon",handler:this.delTreenode,scope:this}],loader:a,root:c,listeners:{nodedragover:{scope:this,fn:function(f){if(f.target.attributes.attributes.write_p==0){f.cancel=true}if(f.source.tree){if(f.target.attributes.attributes.type=="album"){f.cancel=true}}if(f.source.view){if(f.target.attributes.attributes.type=="folder"){f.cancel=true}}}},nodedrop:{scope:this,fn:function(f){var g={target_folder_id:f.target.id,item_id:f.data.node.id,type:f.data.node.attributes.attributes.type};this.paCore.doAction("movenode",function(){},function(){},null,g,this)}},beforenodedrop:{scope:this,fn:function(i){if(i.source.tree){if(i.target.attributes.attributes.type=="album"){i.cancel=true}}if(i.source.view){i.cancel=true;if(i.target.attributes.attributes.type=="album"){i.dropStatus=true;var g=[];for(var f=0;f<i.data.nodes.length;f++){g.push(i.data.nodes[f].id.substring(4,i.data.nodes[f].id.length))}var k={target_album_id:i.target.id,image_ids:g};var j=function(){this.photoStore.reload()};var h=this.genericErrorFn;this.paCore.doAction("movephoto",j,h,null,k,this)}}}}}});c.on("expand",function(){b.fireEvent("click",c)},this,{single:true});b.on("click",this.loadPhotos,this);b.on("render",function(){if(this.config.user==0){b.getTopToolbar().hide()}},this);d.on("beforeshow",function(){var f=b.getSelectionModel().getSelectedNode();var e=f.attributes.attributes.type;if(e=="folder"){d.items.items[0].enable();d.items.items[1].enable();d.items.items[2].disable()}else{d.items.items[0].disable();d.items.items[1].disable();d.items.items[2].enable()}});return b},createCenter:function(){var c=[{text:acs_lang_text.collection||"Add a collection of photos to this album",icon:"/resources/ajaxhelper/icons/add.png",cls:"x-btn-text-icon",handler:function(){if(!this.checkPerms("write")){Ext.MessageBox.alert("Permission Denied","Sorry you do not have permission to perform this action.");return}var h=this.createOrGetWindow("pa-win-newcollection");var f="new_photo_collection_form";var e=Ext.getCmp(f);var d=function(j){Ext.getCmp("new_photo_collection_formid").setValue("photos_upload");var i=this.getSelectedTreeNodeId();Ext.getCmp("new_photo_collection_albumid").setValue(i);Ext.getCmp("new_photo_collection_photoid").setValue(j.responseText);Ext.getCmp("new_photo_collection_returnurl").setValue(this.xmlhttpurl+"formok");h.show()};var g=function(){if(e.getForm().isValid()){e.getForm().submit({url:this.config.package_url+"photos-add-2",waitMsg:"Uploading photo...",reset:true,scope:this,success:function(i,j){if(j.result){this.photoStore.reload();h.close()}else{Ext.MessageBox.alert("Error","Sorry an error occured. Make sure you have filled up all required fields.")}},failure:function(i,j){if(j.result){Ext.MessageBox.alert("Error",j.result.info)}else{Ext.MessageBox.alert("Error","Error occurred. Try again later")}}})}};e.getForm().reset();e.buttons[0].setHandler(g,this);e.buttons[0].setText("Upload");this.paCore.doAction("getnextobjid",d,this.genericErrorFn,null,null,this)},scope:this}];c.push({text:"Download selected Photos",tooltip:"Download selected photos. Press CTRL and then click on the photos you want to select",icon:"/resources/ajaxhelper/icons/arrow_down.png",cls:"x-btn-text-icon",handler:function(){var e=Ext.getCmp("pa-thumbsview-data").getSelectedNodes();if(e.length<1){Ext.Msg.alert("Error","Please select one or more photos to download")}else{var f=[];for(var d=0;d<e.length;d++){f.push(e[d].id.substring(4))}window.location.href="/ajaxpa/batchdownload/?photo_ids="+f}},scope:this});var b=new Ext.Panel({id:"pa-thumbsview",layout:"fit",plain:true,titlebar:false,tbar:c,bbar:new Ext.PagingToolbar({pageSize:parseInt(this.config.pagesize),displayInfo:true,emptyMsg:"No photos found",store:this.photoStore}),listeners:{render:{fn:function(d){d.body.addListener("click",function(g,i){var h=i.id.split("-");var k=h[1];switch(i.className){case"img_view":var f=this.photoStore.getById(k);var j=this.photoStore.indexOf(f);Shadowbox.open(this.shadowbox_gallery);Shadowbox.change(j);break;case"img_edit":this.editPhoto(k);break;case"img_delete":this.delPhoto(k);break;case"img_download":var f=this.photoStore.getById(k);window.location.href="/ajaxpa/download/"+f.get("view_image_id");break}},this)},scope:this}},items:new Ext.DataView({id:"pa-thumbsview-data",store:this.photoStore,tpl:this.thumbTemplate,style:"overflow:auto",overClass:"x-view-over",multiSelect:true,itemSelector:"div.thumb-wrap",loadingText:'<div class="largetext">Fetching photos . . .</div>',emptyText:'<div class="largetext">No photos found</div>',plugins:new Ext.DataView.DragSelector({dragSafe:true}),prepareData:function(d){d.caption=Ext.util.Format.ellipsis(d.caption,20);return d},listeners:{mouseenter:{fn:function(d,f,g,h){var i=Ext.get(g).id.substring(4,Ext.get(g).id.length);Ext.get("tools-"+i).show()},scope:this},mouseleave:{fn:function(d,f,g,h){var i=Ext.get(g).id.substring(4,Ext.get(g).id.length);Ext.get("tools-"+i).hide()},scope:this},dblclick:{fn:function(f,g,h,i){var k=Ext.get(h).id.substring(4,Ext.get(h).id.length);var d=this.photoStore.getById(k);var j=this.photoStore.indexOf(d);Shadowbox.open(this.shadowbox_gallery);Shadowbox.change(j)},scope:this}}})});var a=new Ext.Panel({id:"pa-card",layout:"card",region:"center",activeItem:0,items:[{xtype:"panel",html:'<div class="largetext">Click on an album to view photos</div>'},b]});return a},loadPhotos:function(a,b){if(a.attributes.attributes.type=="album"){Ext.getCmp("pa-card").layout.setActiveItem(1);this.photoStore.baseParams={album_id:a.id,package_id:this.config.package_id};this.photoStore.load({params:{start:0,limit:parseInt(this.config.pagesize)}})}else{Ext.getCmp("pa-card").layout.setActiveItem(0)}},refreshTreenode:function(){var a=Ext.getCmp("pa-nav").getSelectionModel().getSelectedNode();a.fireEvent("click",a)},delTreenode:function(){if(!this.checkPerms("write")){Ext.MessageBox.alert("Permission Denied","Sorry you do not have permission to perform this action.");return}var a=Ext.getCmp("pa-nav");var d=a.getSelectionModel().getSelectedNode();var b=d.attributes.attributes.type;if(a.getRootNode().id==d.id){Ext.Msg.alert("Error","Sorry, you can not delete the root folder")}else{if(b==="folder"){var e="deletefolder";var g={confirmed_p:"t",folder_id:d.id,return_url:this.xmlhttpurl+"formok"}}if(b==="album"){var e="deletealbum";var g={confirmed_p:"t",album_id:d.id,return_url:this.xmlhttpurl+"formok"}}var f=function(i){var h=d.parentNode;h.fireEvent("click",h);h.removeChild(d)};var c=this.genericErrorFn;if(e){Ext.MessageBox.confirm("Delete","Are you sure you want to delete <b>"+d.text+"</b> ?",function(h){if(h==="yes"){this.paCore.doAction(e,f,c,null,g,this)}},this)}}},addTreenode:function(a){if(!this.checkPerms("write")){Ext.MessageBox.alert("Permission Denied","Sorry you do not have permission to perform this action.");return}if(a==="folder"){var i="pa-win-newfolder";var f="new_folder_form";var l="addfolder";var b=acs_lang_text.newfolder||"New Folder";var k=function(n){Ext.getCmp("new_folder_formid").setValue("folder_add");var m=this.getSelectedTreeNodeId();Ext.getCmp("new_folder_parentid").setValue(m);Ext.getCmp("new_folder_folderid").setValue(n.responseText);Ext.getCmp("new_folder_returnurl").setValue(this.xmlhttpurl+"load-onenode?type=folder&node_id="+n.responseText);g.show()};var d="Creating folder"}if(a==="album"){var i="pa-win-newalbum";var f="new_album_form";var l="addalbum";var b=acs_lang_text.newalbum||"New Album";var k=function(n){Ext.getCmp("new_album_formid").setValue("album_add");var m=this.getSelectedTreeNodeId();Ext.getCmp("new_album_parentid").setValue(m);Ext.getCmp("new_album_albumid").setValue(n.responseText);Ext.getCmp("new_album_returnurl").setValue(this.xmlhttpurl+"load-onenode?type=album&node_id="+n.responseText);g.show()};var d="Creating album"}var g=this.createOrGetWindow(i);var h=Ext.getCmp(f);var j=function(m,n){if(n.result){if(n.result.info!="null"){this.addTreenodeEl(n.result.info)}else{Ext.MessageBox.alert("Error","Sorry an error occured. Please try again later.")}g.hide()}else{Ext.MessageBox.alert("Error","Sorry an error occured. Make sure you have filled up all required fields.")}};var c=function(m,n){if(n.result){Ext.MessageBox.alert("Error",n.result.info)}else{Ext.MessageBox.alert("Error","Error occurred. Try again later")}};var e=function(){this.paCore.formSubmit(l,h.getForm(),d,null,true,j,c,this)};if(g){g.setTitle(b);h.buttons[0].setHandler(e,this);h.buttons[0].setText("Create");this.paCore.doAction("getnextobjid",k,this.genericErrorFn,null,null,this)}},addTreenodeEl:function(c){var a=Ext.getCmp("pa-nav");var d=a.getSelectionModel().getSelectedNode();var b=new Ext.tree.TreeNode(c);var e=d.appendChild(b);a.getSelectionModel().select(e);e.loaded=true;e.fireEvent("click",e)},editTreenode:function(){if(!this.checkPerms("write")){Ext.MessageBox.alert("Permission Denied","Sorry you do not have permission to perform this action.");return}var e=Ext.getCmp("pa-nav").getSelectionModel().getSelectedNode();if(e){var f=e.attributes.attributes.type;var k=e.id;if(f==="folder"){var j="pa-win-newfolder";var g="new_folder_form";var a=acs_lang_text.editfolder||"Edit Folder";var n="editfolder";var m=function(q){var p=Ext.decode(q.responseText);if(p.success){Ext.getCmp("new_folder_formid").setValue("folder_edit");Ext.getCmp("new_folder_folderid").setValue(p.info.id);Ext.getCmp("new_folder_name").setValue(p.info.text);Ext.getCmp("new_folder_desc").setValue(p.info.qtip);Ext.getCmp("new_folder_returnurl").setValue(this.xmlhttpurl+"load-onenode?type=folder&node_id="+p.info.id);h.show()}};var c="Updating folder ..."}if(f==="album"){var j="pa-win-newalbum";var g="new_album_form";var a=acs_lang_text.editalbum||"Edit Album";var n="editalbum";var m=function(q){var p=Ext.decode(q.responseText);if(p.success){Ext.getCmp("new_album_formid").setValue("edit_album");Ext.getCmp("new_album_albumid").setValue(p.info.id);Ext.getCmp("new_album_name").setValue(p.info.text);Ext.getCmp("new_album_desc").setValue(p.info.qtip);Ext.getCmp("new_album_story").setValue(p.info.attributes.story);Ext.getCmp("new_album_photographer").setValue(p.info.attributes.photographer);Ext.getCmp("new_album_revisionid").setValue(p.info.attributes.revision_id);Ext.getCmp("new_album_prevrevisionid").setValue(p.info.attributes.previous_revision);Ext.getCmp("new_album_returnurl").setValue(this.xmlhttpurl+"load-onenode?type=album&node_id="+p.info.id);h.show()}};var c="Updating album ..."}var h=this.createOrGetWindow(j);var i=Ext.getCmp(g);var l=function(o,p){if(p.result){if(p.result.info!="null"){this.editTreenodeEl(p.result.info)}else{Ext.MessageBox.alert("Error","Sorry an error occured updating. Please try again later.")}h.hide()}else{Ext.MessageBox.alert("Error","Sorry an error occured. Make sure you have filled up all required fields.")}};var b=function(o,p){if(p.result){Ext.MessageBox.alert("Error",p.result.info)}else{Ext.MessageBox.alert("Error","Error occurred. Try again later")}};var d=function(){this.paCore.formSubmit(n,i.getForm(),c,null,true,l,b,this)};if(h){h.setTitle(a);i.buttons[0].setHandler(d,this);i.buttons[0].setText("Update");Ext.Ajax.request({url:this.config.xmlhttpurl+"load-onenode",params:{type:f,node_id:k,mode:"edit"},success:m,failure:this.genericErrorFn,scope:this})}}else{Ext.Msg.alert("Error","Please select a folder or album")}},editTreenodeEl:function(a){var b=Ext.getCmp("pa-nav").getSelectionModel().getSelectedNode();b.setText(a.text);b.ui.getTextEl().setAttributeNS("ext","qtip",a.qtip)},getSelectedTreeNodeId:function(){var a=Ext.getCmp("pa-nav").getSelectionModel().getSelectedNode().id;return a},createOrGetWindow:function(a){var b=Ext.getCmp(a);if(!b){switch(a){case"pa-win-newcollection":b=new Ext.Window({id:"pa-win-newphotocollection",title:acs_lang_text.collection||"Add a collection of photos to this album",width:290,height:140,autoScroll:true,modal:true,draggable:false,resizable:false,items:[{id:"new_photo_collection_form",xtype:"form",titlebar:false,plain:true,autoHeight:true,bodyStyle:{padding:"5px"},labelAlign:"top",method:"post",fileUpload:true,items:[{id:"new_photo_collection_formid",xtype:"hidden",name:"form:id",value:"photos_upload"},{id:"new_photo_collection_formode",xtype:"hidden",name:"form:mode",value:"edit"},{id:"new_photo_collection_returnurl",xtype:"hidden",name:"return_url",value:""},{id:"new_photo_collection_photoid",xtype:"hidden",name:"photo_id",value:""},{id:"new_photo_collection_albumid",xtype:"hidden",name:"album_id",value:""},{id:"new_photo_collection_file",xtype:"fileuploadfield",name:"upload_file",fieldLabel:"Choose a tar or zip file to upload",allowBlank:false,anchor:"95%",buttonCfg:{text:"",iconCls:"upload-icon"}}],buttons:[{text:"Upload",name:"formbutton:ok",scope:this,icon:"/resources/ajaxhelper/icons/accept.png",cls:"x-btn-text-icon"},{text:"Close",handler:function(){Ext.getCmp("new_photo_collection_form").getForm().reset();Ext.getCmp("pa-win-newphotocollection").close()},scope:this,icon:"/resources/ajaxhelper/icons/cross.png",cls:"x-btn-text-icon"}]}]});break;case"pa-win-newphoto":b=new Ext.Window({id:"pa-win-newphoto",title:acs_lang_text.uploadphoto||"Upload a New Photo",width:290,height:360,autoScroll:true,closeAction:"hide",modal:true,draggable:false,resizable:false,items:[{id:"new_photo_form",xtype:"form",titlebar:false,plain:true,autoHeight:true,bodyStyle:{padding:"5px"},labelAlign:"top",method:"post",fileUpload:true,items:[{id:"new_photo_formid",xtype:"hidden",name:"form:id",value:"photo_upload"},{id:"new_photo_formode",xtype:"hidden",name:"form:mode",value:"edit"},{id:"new_photo_returnurl",xtype:"hidden",name:"return_url",value:""},{id:"new_photo_photoid",xtype:"hidden",name:"photo_id",value:""},{id:"new_photo_albumid",xtype:"hidden",name:"album_id",value:""},{id:"new_photo_file",xtype:"fileuploadfield",name:"upload_file",fieldLabel:"Photo",allowBlank:false,emptyText:"Choose a photo to upload",anchor:"95%",buttonCfg:{text:"",iconCls:"upload-icon"}},{id:"new_photo_caption",xtype:"textfield",name:"caption",fieldLabel:"Caption",width:220},{id:"new_photo_desc",xtype:"textarea",name:"description",fieldLabel:"Description",width:220},{id:"new_photo_story",xtype:"textarea",name:"story",fieldLabel:"Story",width:220}],buttons:[{text:"Upload",name:"formbutton:ok",scope:this,icon:"/resources/ajaxhelper/icons/accept.png",cls:"x-btn-text-icon"},{text:"Close",handler:function(){Ext.getCmp("new_photo_form").getForm().reset();Ext.getCmp("pa-win-newphoto").hide()},scope:this,icon:"/resources/ajaxhelper/icons/cross.png",cls:"x-btn-text-icon"}]}]});break;case"pa-win-editphoto":b=new Ext.Window({id:"pa-win-editphoto",title:acs_lang_text.editphoto||"Edit Photo Attributes",width:290,height:360,autoScroll:true,closeAction:"hide",modal:true,draggable:false,resizable:false,listeners:{show:{scope:this,fn:function(){Ext.getCmp("edit_photo_title").focus(false,10)}}},items:[{id:"edit_photo_form",xtype:"form",titlebar:false,plain:true,autoHeight:true,bodyStyle:{padding:"5px"},labelAlign:"top",method:"post",items:[{id:"edit_photo_formid",xtype:"hidden",name:"form:id",value:"edit_photo"},{id:"edit_photo_formode",xtype:"hidden",name:"form:mode",value:"edit"},{id:"edit_photo_returnurl",xtype:"hidden",name:"return_url",value:""},{id:"edit_photo_photoid",xtype:"hidden",name:"photo_id",value:""},{id:"edit_photo_revisionid",xtype:"hidden",name:"revision_id",value:""},{id:"edit_photo_prevrevisionid",xtype:"hidden",name:"previous_revision",value:""},{id:"edit_photo_title",xtype:"textfield",name:"title",fieldLabel:"Title",width:220},{id:"edit_photo_caption",xtype:"textfield",name:"caption",fieldLabel:"Caption",width:220},{id:"edit_photo_desc",xtype:"textarea",name:"description",fieldLabel:"Description",width:220},{id:"edit_photo_story",xtype:"textarea",name:"story",fieldLabel:"Story",width:220}],buttons:[{text:"Update",name:"formbutton:ok",scope:this,icon:"/resources/ajaxhelper/icons/accept.png",cls:"x-btn-text-icon"},{text:"Close",handler:function(){Ext.getCmp("edit_photo_form").getForm().reset();Ext.getCmp("pa-win-editphoto").hide()},scope:this,icon:"/resources/ajaxhelper/icons/cross.png",cls:"x-btn-text-icon"}]}]});break;case"pa-win-newfolder":b=new Ext.Window({id:"pa-win-newfolder",title:acs_lang_text.newfolder||"New Folder",width:290,height:220,autoScroll:true,closeAction:"hide",modal:true,draggable:false,resizable:false,items:[{id:"new_folder_form",xtype:"form",titlebar:false,plain:true,autoHeight:true,bodyStyle:{padding:"5px"},labelAlign:"top",method:"post",items:[{id:"new_folder_name",xtype:"textfield",name:"label",fieldLabel:"Folder Name",width:220,allowBlank:false},{id:"new_folder_desc",xtype:"textarea",name:"description",fieldLabel:"Folder Description",width:220},{id:"new_folder_formid",xtype:"hidden",name:"form:id",value:"folder_add"},{id:"new_folder_formode",xtype:"hidden",name:"form:mode",value:"edit"},{id:"new_folder_returnurl",xtype:"hidden",name:"return_url",value:""},{id:"new_folder_folderid",xtype:"hidden",name:"folder_id",value:""},{id:"new_folder_parentid",xtype:"hidden",name:"parent_id",value:""}],buttons:[{text:"Create Folder",name:"formbutton:ok",scope:this,icon:"/resources/ajaxhelper/icons/accept.png",cls:"x-btn-text-icon"},{text:"Close",handler:function(){Ext.getCmp("new_folder_form").getForm().reset();Ext.getCmp("pa-win-newfolder").hide()},scope:this,icon:"/resources/ajaxhelper/icons/cross.png",cls:"x-btn-text-icon"}]}],listeners:{show:{scope:this,fn:function(){Ext.getCmp("new_folder_name").focus(false,10)}}}});break;case"pa-win-newalbum":b=new Ext.Window({id:"pa-win-newalbum",title:acs_lang_text.newalbum||"New Abum",width:290,autoHeight:true,autoScroll:true,closeAction:"hide",modal:true,draggable:false,resizable:false,listeners:{show:{scope:this,fn:function(){Ext.getCmp("new_album_name").focus(false,10)}}},items:[{id:"new_album_form",xtype:"form",titlebar:false,plain:true,autoHeight:true,bodyStyle:{padding:"5px"},labelAlign:"top",method:"post",items:[{id:"new_album_name",xtype:"textfield",name:"title",fieldLabel:"Album Name",width:220,allowBlank:false},{id:"new_album_photographer",xtype:"textfield",name:"photographer",fieldLabel:"Photographer",width:220},{id:"new_album_desc",xtype:"textarea",name:"description",fieldLabel:"Description",width:220},{id:"new_album_story",xtype:"textarea",name:"story",fieldLabel:"Album Story",width:220},{id:"new_album_formid",xtype:"hidden",name:"form:id",value:"album_add"},{id:"new_album_formmode",xtype:"hidden",name:"form:mode",value:"edit"},{id:"new_album_returnurl",xtype:"hidden",name:"return_url",value:""},{id:"new_album_albumid",xtype:"hidden",name:"album_id",value:""},{id:"new_album_revisionid",xtype:"hidden",name:"revision_id",value:""},{id:"new_album_prevrevisionid",xtype:"hidden",name:"previous_revision",value:""},{id:"new_album_parentid",xtype:"hidden",name:"parent_id",value:""}],buttons:[{text:"Create Album",name:"formbutton:ok",scope:this,icon:"/resources/ajaxhelper/icons/accept.png",cls:"x-btn-text-icon"},{text:"Close",handler:function(){Ext.getCmp("new_album_form").getForm().reset();Ext.getCmp("pa-win-newalbum").hide()},scope:this,icon:"/resources/ajaxhelper/icons/cross.png",cls:"x-btn-text-icon"}]}]});break}}return b},newPhoto:function(){if(!this.checkPerms("write")){Ext.MessageBox.alert("Permission Denied","Sorry you do not have permission to perform this action.");return}var e=this.createOrGetWindow("pa-win-newphoto");var c="new_photo_form";var b=Ext.getCmp(c);var a=function(g){Ext.getCmp("new_photo_formid").setValue("photo_upload");var f=this.getSelectedTreeNodeId();Ext.getCmp("new_photo_albumid").setValue(f);Ext.getCmp("new_photo_photoid").setValue(g.responseText);Ext.getCmp("new_photo_returnurl").setValue(this.xmlhttpurl+"formok");e.show()};var d=function(){if(b.getForm().isValid()){b.getForm().submit({url:this.config.package_url+"photo-add-2",waitMsg:"Uploading photo...",reset:true,scope:this,success:function(f,g){if(g.result){this.photoStore.reload();e.hide()}else{Ext.MessageBox.alert("Error","Sorry an error occured. Make sure you have filled up all required fields.")}},failure:function(f,g){if(g.result){Ext.MessageBox.alert("Error",g.result.info)}else{Ext.MessageBox.alert("Error","Error occurred. Try again later")}}})}};b.getForm().reset();b.buttons[0].setHandler(d,this);b.buttons[0].setText("Upload");this.paCore.doAction("getnextobjid",a,this.genericErrorFn,null,null,this)},delPhoto:function(a){Ext.MessageBox.confirm("Delete","Are you sure you want to delete this photo?",function(b){if(b==="yes"){var d=function(e){this.photoStore.reload()};var c=this.genericErrorFn;this.paCore.doAction("deletephoto",d,c,null,{confirmed_p:"t",photo_id:a,return_url:this.xmlhttpurl+"formok"},this)}},this)},editPhoto:function(f){var e=this.createOrGetWindow("pa-win-editphoto");var c="edit_photo_form";var b=Ext.getCmp(c);var a=function(h){var g=Ext.decode(h.responseText);if(g.success){Ext.getCmp("edit_photo_formid").setValue("edit_photo");Ext.getCmp("edit_photo_returnurl").setValue(this.xmlhttpurl+"get-onephoto?photo_id="+g.info.photo_id+"&package_id="+this.config.package_id+"&mode=display");Ext.getCmp("edit_photo_photoid").setValue(g.info.photo_id);Ext.getCmp("edit_photo_revisionid").setValue(g.info.revision_id);Ext.getCmp("edit_photo_prevrevisionid").setValue(g.info.prevrevision_id);Ext.getCmp("edit_photo_title").setValue(g.info.title);Ext.getCmp("edit_photo_caption").setValue(g.info.caption);Ext.getCmp("edit_photo_desc").setValue(g.info.description);Ext.getCmp("edit_photo_story").setValue(g.info.story);e.show()}};var d=function(){if(b.getForm().isValid()){var h=function(j,k){if(k.result){if(k.result.info!="null"){Ext.get("caption-"+k.result.info.photo_id).update(k.result.info.caption);if(k.result.info.story&&k.result.info.story!=""){var i=document.createAttribute("ext:qtip");i.value=k.result.info.story;Ext.get("thumb"+k.result.info.photo_id).dom.attributes.setNamedItem(i)}}else{Ext.MessageBox.alert("Error","Sorry an error occured trying to create your new folder. Please try again later.")}Ext.getCmp("pa-win-editphoto").hide()}else{Ext.MessageBox.alert("Error","Sorry an error occured. Make sure you have filled up all required fields.")}};var g=function(i,j){if(j.result){Ext.MessageBox.alert("Error",j.result.info)}else{Ext.MessageBox.alert("Error","Error occurred. Try again later")}};this.paCore.formSubmit("editphoto",currentfor.getForm(),"Updating photo ....",null,true,h,g,this)}};b.buttons[0].setHandler(d,this);b.buttons[0].setText("Update");this.paCore.doAction("getonephoto",a,this.genericErrorFn,null,{photo_id:f,package_id:this.config.package_id,mode:"edit"},this)}};